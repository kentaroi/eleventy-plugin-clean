# eleventy-plugin-clean
[![CI](https://github.com/kentaroi/eleventy-plugin-clean/actions/workflows/CI/badge.svg?branch=main)](https://github.com/kentaroi/eleventy-plugin-clean/actions?query=branch%3Amain+workflow%3ACI)
[![License: MIT](https://img.shields.io/badge/License-MIT-blue.svg)](https://opensource.org/licenses/MIT)

This is an experimental plugin for Eleventy to keep the output directory clean.

You wouldn't do anything crazy like that, but please don't put your valuable files directly in your `output` directory without a backup.

## Installation

```bash
npm install eleventy-plugin-clean
```

Add it to Eleventy config file (usually `.eleventy.js`)

```JavaScript
const clean = require("eleventy-plugin-clean");

module.exports = function(eleventyConfig) {
  eleventyConfig.addPlugin(clean);
};
```

If you are using `git`, add the following line to your `.gitignore`.
```gitignore
.elventy-plugin-clean
```

If you are not using `git`, add it to your `.eleventyignore` file instead of the `.gitignore` file.

## Usage

eleventy-plugin-clean does not delete files which were not generated from Eleventy or have been generated before the installation of the plugin.

Therefore, you may want to clean the output directory once first.
```bash
rm -rf _site/*
```

## What it actually does

eleventy-plugin-clean uses LMDB, a key-value store, to store all the data needed to keep the `output` directory clean. The DB is located at `.eleventy-plugin-clean` in your project root.

eleventy-plugin-clean keeps the build number of Eleventy project.
The build number is an integer value that eleventy-plugin-clean automatically increases with each Eleventy build.

It uses the key-value store to store build numbers for the files in the `output` directory.
In other words, it knows all of the files in the output directory and each of the file records has its build number that generated the file.

When Eleventy (re)builds the site, eleventy-plugin-clean updates the build numbers for all of the output files generated by the build.

At the end of each build, eleventy-plugin-clean removes the files in the `output` directory which have a build number older than the current build number and also deletes their records from the key-value store.

## Limitations

Suppose you are running `npx @11ty/eleventy --serve`.

This plugin does not detect file deletions since Eleventy doesn't listen `unlink` events but only listens `change` and `add` events:

https://github.com/11ty/eleventy/blob/1db6a10a98f35b6f6bcac94222cdd8597e6f7928/src/Eleventy.js#L953-L961

Therefore, when you remove a file from your `input` directory, nothing will happen.

However, after that, if you change or add another file or if you re-run `npx @11ty/eleventy --serve` or `npx @11ty/eleventy`, it will remove the file(s) in the `output` directory which had been generated from the above removed file.
